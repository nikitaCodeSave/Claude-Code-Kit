---
description: Создаёт детальный план реализации фичи или задачи. Использовать при упоминании "plan", "design", "architect", или перед реализацией фич > 50 строк кода.
allowed-tools: Read, Write, Edit, Grep, Glob, Bash, WebSearch
---

# Планирование: $ARGUMENTS

## ШАГ 0: Проверка инициализации (ОБЯЗАТЕЛЬНО ПЕРВЫМ)

```bash
# Проверить наличие воркспейса
if [ ! -d ".claude-workspace" ]; then
  echo "WORKSPACE_NOT_FOUND"
fi
```

**Если `.claude-workspace` не существует:**

> ❌ **Воркспейс не инициализирован.**
>
> Выполните `/init-project` для создания структуры проекта.
>
> **Прерываю выполнение.**

**НЕ ПРОДОЛЖАТЬ без инициализированного воркспейса.**

---

## ШАГ 1: Проверка активной задачи

```bash
# Проверить текущую задачу
if [ -f ".claude-workspace/current-task.md" ]; then
  head -10 .claude-workspace/current-task.md
fi
```

**Если файл содержит `## Задача:` или `## Task:` (не пустой шаблон):**

> ⚠️ **Найдена незавершённая задача:**
> [показать первые 3-5 строк]
>
> **Варианты:**
> 1. `/complete-task` — архивировать и начать новую
> 2. Продолжить и перезаписать (скажите "да")
> 3. Отмена (скажите "нет")

**Дождаться ответа пользователя. Не продолжать автоматически.**

---

## ШАГ 2: Определение сложности

| Размер | Строк кода | Шагов | Подход |
|--------|------------|-------|--------|
| **S** | < 50 | 1-3 | Простой план, выполнить сразу |
| **M** | 50-200 | 4-6 | Детальный план |
| **L** | 200-500 | 7-10 | Декомпозиция на подзадачи, использовать "think hard" |
| **XL** | > 500 | 10+ | Разбить на несколько `/create-plan`, использовать "ultrathink" |

---

## ШАГ 3: Исследование

### 3.1 Локальный анализ проекта

```bash
# Структура проекта
tree -L 2 -I 'node_modules|__pycache__|.git|.venv|venv|dist|build|.next' 2>/dev/null || ls -la

# Существующие паттерны
cat CLAUDE.md 2>/dev/null | head -50

# Недавние коммиты (контекст)
git log --oneline -5 2>/dev/null

# Статус фич
cat .claude-workspace/features.json 2>/dev/null | head -30
```

**Для Python проектов:**
```bash
rg "class.*Service|class.*Handler|class.*Manager" --type py -l 2>/dev/null | head -10
rg "@(app|router)\.(get|post|put|delete)" --type py -C 1 2>/dev/null | head -20
```

**Для TypeScript/JavaScript проектов:**
```bash
rg "export (default )?(function|const) \w+" --type ts -l 2>/dev/null | head -10
rg "export class \w+" --type ts 2>/dev/null | head -10
```

### 3.2 WebSearch (только когда нужно)

**Использовать WebSearch если:**
- Выбор между технологиями/библиотеками
- Незнакомая предметная область
- Нужны современные best practices

**НЕ использовать если:**
- Простой багфикс или рефакторинг
- Паттерн уже установлен в проекте
- Задача в рамках существующего кода

**Примеры запросов:**
- `[задача] best practices`
- `[подход A] vs [подход B] comparison`
- `Python [задача] popular libraries`

---

## ШАГ 4: Глубокий анализ

**Ответить на вопросы (использовать "think hard" для L/XL задач):**

1. Какие файлы нужно изменить?
2. Какие новые файлы создать?
3. Какие зависимости добавить?
4. Какие риски есть?
5. Как это повлияет на существующий код?
6. Какие тесты нужны?

---

## ШАГ 5: Выбор решения (если есть альтернативы)

При наличии нескольких вариантов реализации:

1. **Рекомендация** (выделить):
   > **Рекомендую:** [решение] — [краткое обоснование в 1 предложении]

2. **Альтернативы** (кратко):
   - Вариант B: [когда лучше подходит]
   - Вариант C: [для каких случаев]

3. **Продолжение:**
   > Продолжаю с рекомендацией. Скажите если хотите другой вариант.

---

## ШАГ 6: Документирование плана

Записать в `.claude-workspace/current-task.md`:

```markdown
## Задача: [название]

### Цель
[Чёткая цель в 1-2 предложения]

### Метаданные
- **Сложность:** S/M/L/XL
- **Шагов:** N
- **Риск:** Низкий/Средний/Высокий
- **Создано:** [дата]

### Scope

**Входит:**
- ...

**Не входит:**
- ...

### Шаги реализации

1. [ ] **[Заголовок]**
   - Файлы: `path/to/file`
   - Что сделать: [описание]
   - Тесты: [что проверить]

2. [ ] **[Заголовок]**
   ...

### Файлы

**Создать:**
- `src/services/new_service.py` — [назначение]

**Изменить:**
- `src/main.py` — [какие изменения]

### Зависимости
- [пакеты если нужны]

### Критерии успеха
- [ ] Все тесты проходят
- [ ] Нет ошибок линтера
- [ ] [Конкретный критерий]

### Риски (для M/L/XL)
| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| ... | Низкая/Средняя/Высокая | ... |
```

---

## ШАГ 7: Обновление отслеживания

```bash
# Обновить progress.md
echo "" >> .claude-workspace/progress.md
echo "## $(date '+%Y-%m-%d %H:%M') - План: $ARGUMENTS" >> .claude-workspace/progress.md
echo "- Статус: План создан" >> .claude-workspace/progress.md
echo "- Сложность: [S/M/L/XL]" >> .claude-workspace/progress.md
```

**Обновить features.json** — добавить/обновить запись:

```json
{
  "id": "FXXX",
  "name": "$ARGUMENTS",
  "slug": "[kebab-case]",
  "status": "planned",
  "priority": "2",
  "description": "[из цели]",
  "createdAt": "[ISO timestamp]",
  "updatedAt": "[ISO timestamp]"
}
```

---

## ШАГ 8: ADR (если был выбор из альтернатив)

Если при планировании выбран один подход из нескольких, добавить в `.claude-workspace/decisions.md`:

```markdown
## ADR-NNN: [Название решения]

**Дата:** [дата]
**Статус:** Принято
**Контекст задачи:** $ARGUMENTS

### Проблема
[Почему возникла необходимость выбора]

### Решение
[Что выбрано и почему]

### Альтернативы
- [Вариант A] — [почему отклонён]

### Последствия
- [+] Положительные
- [-] Риски/компромиссы
```

---

## ШАГ 9: Запрос подтверждения

Показать краткое резюме:

> **План готов:**
> - **Задача:** [название]
> - **Сложность:** [S/M/L/XL]
> - **Шагов:** N
> - **Ключевые файлы:** [2-3 файла]
> - **Основной риск:** [если есть]
>
> **Начать реализацию с `/implement`?**

**Дождаться явного подтверждения** ("да", "proceed", "начинай", "go").

---

## Ограничения

### ЗАПРЕЩЕНО
- Писать код (только описания)
- Начинать реализацию без подтверждения
- Шаги длиннее 30 минут работы
- Пропускать тесты в плане
- Продолжать без проверки `.claude-workspace`

### ОБЯЗАТЕЛЬНО
- Проверить воркспейс первым шагом
- Указать риски для M/L/XL задач
- Включить тесты в каждый шаг
- Дождаться подтверждения перед `/implement`
- Использовать "think hard" / "ultrathink" для сложных задач
