---
description: Создаёт детальный план реализации фичи или задачи. Использовать при упоминании "plan", "design", "architect", или перед реализацией фич > 50 строк кода.
allowed-tools: Read, Write, Edit, Grep, Glob, Bash
---
# Планирование фичи/задачи: $ARGUMENTS

> `$ARGUMENTS` — описание задачи после команды
> Пример: `/create-plan user authentication` → $ARGUMENTS = "user authentication"

Создай детальный план для задачи. **НЕ ПИШИ КОД.**

## Сбор контекста

При вызове СНАЧАЛА:

```bash
# 1. Текущий прогресс
cat .claude-workspace/progress.md 2>/dev/null | tail -20

# 2. Есть ли уже план?
cat .claude-workspace/current-task.md 2>/dev/null | head -15

# 3. Недавние коммиты (контекст)
git log --oneline -5 2>/dev/null
```

## Матрица размера задачи

| Размер | Строк кода | Шагов | Подход |
|--------|------------|-------|--------|
| S | < 50 | 1-3 | Простой план |
| M | 50-200 | 4-6 | Детальный план |
| L | 200-500 | 7-10 | Декомпозиция на подзадачи |
| XL | > 500 | 10+ | Несколько /create-plan сессий |

## Процесс

### 1. Исследование (используй explore-agent для сложных задач)

```bash
# Изучи структуру проекта
tree -L 2 -I 'node_modules|__pycache__|.git|.venv|venv' | head -40

# Python: найти сервисы/классы
rg "class.*Service|class.*Handler|class.*Manager" --type py -l | head -10

# Python: найти эндпоинты FastAPI/Flask
rg "@(app|router)\.(get|post|put|delete|patch)" --type py -C 2 | head -30

# Проверь существующие паттерны
cat CLAUDE.md 2>/dev/null | head -50
```

### 2. Глубокий анализ подхода

Ответь на вопросы:
- Какие файлы нужно изменить?
- Какие новые файлы создать?
- Какие зависимости добавить?
- Какие риски есть?
- Как это повлияет на существующий код?
- Какие тесты нужны?

### 3. Документирование плана

Запиши план в `.claude-workspace/current-task.md`:

```markdown
## Задача: [название]

### Цель
[Чёткая цель в 1-2 предложения]

### Сложность: S/M/L/XL
### Количество шагов: N
### Уровень риска: Низкий/Средний/Высокий

### Область
**Входит в scope:**
- ...

**Не входит в scope:**
- ...

### Шаги реализации
1. [ ] **Шаг 1: [Заголовок]**
   - Файлы: `path/to/file`
   - Изменения: [что изменить]
   - Тесты: [что тестировать]
   - Оценка времени: X мин

2. [ ] **Шаг 2: [Заголовок]**
   ...

### Файлы для создания
- `src/services/new_service.py` — [назначение]
- `tests/test_new_service.py` — [тесты]

### Файлы для изменения
- `src/main.py` — [какие изменения]

### Зависимости
- [если нужны новые пакеты в requirements.txt]

### Критерии успеха
- [ ] Все тесты проходят
- [ ] Нет ошибок линтера
- [ ] [Конкретный критерий 1]
- [ ] [Конкретный критерий 2]

### Риски и митигации
| Риск | Митигация |
|------|-----------|
| ... | ... |
```

### 4. Обновление отслеживания

```bash
# Обнови progress.md
echo "## $(date '+%Y-%m-%d %H:%M') - Planning: $ARGUMENTS" >> .claude-workspace/progress.md
echo "- Status: Plan created" >> .claude-workspace/progress.md
echo "" >> .claude-workspace/progress.md

# Если новая фича - добавь в features.json
```

### 5. Документирование архитектурных решений (если применимо)

Если при планировании был выбран один подход из нескольких возможных,
добавь запись в `.claude-workspace/decisions.md`:

```markdown
## ADR-NNN: [Название решения]

**Дата:** $(date '+%Y-%m-%d')
**Статус:** Принято
**Контекст:** $ARGUMENTS

### Контекст
[Почему возникла необходимость выбора]

### Решение
[Что было выбрано и почему]

### Рассмотренные альтернативы
- [Вариант A] — [почему отклонён]
- [Вариант B] — [почему отклонён]

### Последствия
- [Положительные последствия]
- [Риски или компромиссы]
```

## Ограничения

### ЗАПРЕЩЕНО
- Писать код в плане (только описания)
- Начинать реализацию без approval пользователя
- Шаги длиннее 30 минут
- Пропускать тесты в плане

### ОБЯЗАТЕЛЬНО
- Указать риски для каждого шага M/L/XL
- Включить тесты в каждый шаг
- Использовать "think hard" или "ultrathink" для сложных задач

## Процесс одобрения

После создания плана:

1. Покажи краткое резюме (5-7 пунктов):
   - Цель
   - Размер (S/M/L/XL)
   - Количество шагов
   - Ключевые файлы
   - Основные риски

2. Спроси явно:
   > "План готов. Продолжить с `/implement`?"

3. Дождись явного подтверждения ("да", "proceed", "начинай")

## Вывод

После создания плана:
1. Покажи краткое резюме
2. Спроси: "План готов. Начинаем имплементацию с `/implement`?"