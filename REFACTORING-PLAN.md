# План рефакторинга Claude Code Kit

**Дата начала:** 2025-12-05
**Текущая фаза:** Фаза 2 завершена

---

## Обзор проекта

| Компонент | Оценка до | Критические проблемы |
|-----------|-----------|---------------------|
| Агенты | 7.5/10 | doc-agent критически неполный (2/10) |
| Команды | 6/10 | plan.md без Write, дублирование в fix-issue/status |
| Workspace | 8/10 | Дублирование логирования |
| Конфигурация | 8/10 | Недокументирована |
| Документация | 6/10 | Отсутствует docs/ директория |

---

## Принятые решения

| Вопрос | Решение |
|--------|---------|
| Язык проекта | Оставить русский |
| security-agent | Удалить упоминание (заменить на review-agent) |
| session-log.txt | Удалить (использовать только progress.md) |

---

## Фаза 1: Критические исправления

> **Статус: ЗАВЕРШЕНА** (2025-12-05)

### Чек-лист

- [x] **1.1 plan.md** — Добавить Write в allowed-tools
  - Файл: `.claude/commands/plan.md`
  - Изменение: `allowed-tools: Read, Grep, Glob, Bash` → `allowed-tools: Read, Write, Edit, Grep, Glob, Bash`

- [x] **1.2 fix-issue.md** — Исправить структуру и YAML
  - Файл: `.claude/commands/fix-issue.md`
  - Изменения:
    - YAML frontmatter перемещён в начало файла
    - Удалено дублирование контента (374 → 275 строк)
    - Структура унифицирована

- [x] **1.3 status.md** — Добавить YAML и убрать дубли
  - Файл: `.claude/commands/status.md`
  - Изменения:
    - Добавлен YAML frontmatter
    - Удалено дублирование (229 → 139 строк)
    - Убраны эмодзи из шаблонов вывода

- [x] **1.4 lead-agent.md** — Удалить security-agent упоминание
  - Файл: `.claude/agents/lead-agent.md`
  - Изменение: Заменено `security-agent` на `review-agent` в секции Delegation Rules

- [x] **1.5 session-log.txt** — Удалить файл
  - Файл: `.claude-workspace/session-log.txt`
  - Изменение: Файл удалён, используется только `progress.md`

---

## Фаза 2: Структура и архитектура

> **Статус: ЗАВЕРШЕНА** (2025-12-05)

### Чек-лист

- [x] **2.1 Проверить структуру директорий**
  - Структура соответствует CLAUDE.md
  - Удалён session-log.txt (остаток от Фазы 1)
  - Выявлено: /fix-issue не упоминается в CLAUDE.md (для Фазы 7)

- [x] **2.2 Создать docs/ директорию**
  - [x] docs/README.md — общее описание (170 строк)
  - [x] docs/WORKFLOW.md — workflow диаграмма (280 строк)
  - [x] docs/COMMANDS.md — справка по командам (420 строк)
  - [x] docs/AGENTS.md — справка по агентам (480 строк)

---

## Фаза 3: Агенты (детальный разбор)

> **Статус: ОЖИДАЕТ**

### Чек-лист

- [ ] **3.1 lead-agent.md** (137 строк) — Оценка: 8/10
  - [ ] OODA цикл корректен
  - [ ] Context Discovery скрипты работают
  - [ ] Примеры output format полные
  - [ ] Delegation rules актуальны

- [ ] **3.2 code-agent.md** (154 строки) — Оценка: 9/10
  - [ ] TDD workflow корректен
  - [ ] Git команды безопасны
  - [ ] Error recovery адекватен
  - [ ] Инструменты соответствуют задачам

- [ ] **3.3 test-agent.md** (204 строки) — Оценка: 8/10
  - [ ] Test scenarios матрица полная
  - [ ] Примеры для Python (pytest) добавлены
  - [ ] MCP tools упомянуты корректно
  - [ ] E2E процесс описан

- [ ] **3.4 review-agent.md** (187 строк) — Оценка: 9/10
  - [ ] Auto-REJECT критерии адекватны
  - [ ] Security patterns работают
  - [ ] Output format полный
  - [ ] Checklist исчерпывающий

- [ ] **3.5 explore-agent.md** (142 строки) — Оценка: 8/10
  - [ ] Search strategies покрывают все случаи
  - [ ] Constraints ясны (определить "большой файл")
  - [ ] Response Guidelines адекватны

- [ ] **3.6 doc-agent.md** (30 строк) — Оценка: 2/10 — **КРИТИЧНО!**
  - [ ] Добавить OODA цикл
  - [ ] Добавить примеры для README, API docs
  - [ ] Добавить Output format
  - [ ] Добавить Context Discovery
  - [ ] Расширить до 80-100+ строк

---

## Фаза 4: Команды (детальный разбор)

> **Статус: ОЖИДАЕТ**

### Чек-лист

- [ ] **4.1 init-project.md** (210 строк) — Оценка: 8/10
  - [ ] Процесс создания файлов корректен
  - [ ] Поддержка разных языков (Node, Python, Rust, Go)
  - [ ] Git setup корректен

- [ ] **4.2 plan.md** (107 строк) — Оценка: 7/10 (после исправления)
  - [x] Write добавлен в allowed-tools
  - [ ] Процесс планирования логичен
  - [ ] Интеграция с current-task.md работает

- [ ] **4.3 implement.md** (121 строка) — Оценка: 8/10
  - [ ] TDD workflow корректен
  - [ ] Pre-implementation checklist полный
  - [ ] Commit стратегия адекватна

- [ ] **4.4 test.md** (201 строка) — Оценка: 8/10
  - [ ] Матрица сценариев полная
  - [ ] Поддержка разных фреймворков
  - [ ] API testing примеры

- [ ] **4.5 review.md** (240 строк) — Оценка: 9/10 — **ОБРАЗЕЦ**
  - [ ] Auto-REJECT критерии адекватны
  - [ ] Severity levels понятны
  - [ ] Before merge checklist полный

- [ ] **4.6 quick-fix.md** (111 строк) — Оценка: 7/10
  - [ ] Constraints ясны (<20 LOC)
  - [ ] TDD процесс для мелких фиксов
  - [ ] Эскалация к /plan если сложно

- [ ] **4.7 fix-issue.md** (275 строк) — Оценка: 8/10 (после исправления)
  - [x] Структура файла исправлена
  - [ ] GitHub CLI интеграция работает
  - [ ] PR создание корректно

- [ ] **4.8 status.md** (139 строк) — Оценка: 8/10 (после исправления)
  - [x] YAML frontmatter добавлен
  - [x] Дубликаты удалены
  - [ ] Compact/full режимы работают

---

## Фаза 5: Workspace и Tracking

> **Статус: ОЖИДАЕТ**

### Чек-лист

- [ ] **5.1 progress.md**
  - [ ] Шаблон для новых сессий корректен
  - [ ] Формат даты/времени консистентен

- [ ] **5.2 features.json**
  - [ ] Схема JSON корректна
  - [ ] Статусы и приоритеты описаны

- [ ] **5.3 current-task.md**
  - [ ] Шаблон полный
  - [ ] Все необходимые разделы есть

- [ ] **5.4 decisions.md**
  - [ ] ADR формат корректен
  - [ ] Шаблон для новых решений

- [x] **5.5 session-log.txt** — УДАЛЁН

---

## Фаза 6: Конфигурация и безопасность

> **Статус: ОЖИДАЕТ**

### Чек-лист

- [ ] **6.1 settings.local.json**
  - [ ] Permissions адекватны
  - [ ] Опасные команды блокированы
  - [ ] Hooks настроены правильно

- [ ] **6.2 validate-bash.sh**
  - [ ] Security patterns полные
  - [ ] Fork bomb detection работает
  - [ ] Dangerous patterns caught
  - [ ] Network commands warnings

---

## Фаза 7: Документация

> **Статус: ОЖИДАЕТ**

### Чек-лист

- [ ] **7.1 CLAUDE.md**
  - [ ] Все команды перечислены (включая quick-fix)
  - [ ] Все агенты описаны
  - [ ] Workflow rules актуальны
  - [ ] Project structure соответствует реальности

- [ ] **7.2 Создать docs/**
  - [ ] docs/README.md
  - [ ] docs/WORKFLOW.md
  - [ ] docs/COMMANDS.md
  - [ ] docs/AGENTS.md

---

## Прогресс

```
Фаза 1 [##########] 100% — ЗАВЕРШЕНА
Фаза 2 [##########] 100% — ЗАВЕРШЕНА
Фаза 3 [          ]   0% — ожидает
Фаза 4 [##        ]  25% — частично (fix, status, plan исправлены)
Фаза 5 [##        ]  20% — частично (session-log удалён)
Фаза 6 [          ]   0% — ожидает
Фаза 7 [          ]   0% — ожидает
```

---

## Следующие шаги

1. **Рекомендуется:** Закоммитить изменения Фаз 1 и 2
2. **Далее:** Фаза 3 (детальный разбор агентов)
3. **Приоритет:** doc-agent.md требует полной переработки (критический — 30 строк → 100+)

---

## Файлы изменённые в Фазе 1

```
ИЗМЕНЕНЫ:
├── .claude/commands/plan.md          (+2 tools в allowed-tools)
├── .claude/commands/fix-issue.md     (реструктуризация, -99 строк)
├── .claude/commands/status.md        (+YAML, -90 строк)
└── .claude/agents/lead-agent.md      (security-agent → review-agent)

УДАЛЕНЫ:
└── .claude-workspace/session-log.txt

СОЗДАНО:
└── REFACTORING-PLAN.md (этот файл)
```

---

## Файлы изменённые в Фазе 2

```
СОЗДАНО:
├── docs/README.md      (170 строк) — общее описание проекта
├── docs/WORKFLOW.md    (280 строк) — workflow диаграммы и процессы
├── docs/COMMANDS.md    (420 строк) — справка по 8 командам
└── docs/AGENTS.md      (480 строк) — справка по 6 агентам

УДАЛЕНО:
└── .claude-workspace/session-log.txt (остаток от Фазы 1)

ОБНОВЛЕНО:
└── REFACTORING-PLAN.md (этот файл)
```
