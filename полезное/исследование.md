# Лучшие практики для мультиагентных проектов Claude Code

Построение эффективных мультиагентных систем Claude Code требует освоения четырёх взаимосвязанных дисциплин: **конфигурация проекта**, **оркестрация агентов**, **персистентность сессий** и **контроль качества**. Это исследование синтезирует официальные рекомендации Anthropic с проверенными паттернами сообщества для предоставления практических рекомендаций по оркестрации больших задач.

Ключевой инсайт от инженерной команды Anthropic: мультиагентные системы с паттерном оркестратор-воркер превосходят одноагентные подходы на 90% на сложных задачах — но требуют тщательной архитектуры. Субагенты обеспечивают «сжатие», исследуя независимо со своими собственными контекстными окнами, прежде чем конденсировать инсайты для ведущего агента.

## Архитектура CLAUDE.md определяет успех проекта

Официальные рекомендации Anthropic позиционируют CLAUDE.md как точку конфигурации с наибольшим рычагом влияния. Файлы загружаются иерархически: `~/.claude/CLAUDE.md` (глобальный) → `./CLAUDE.md` (проект) → `./subdirectory/CLAUDE.md` (по требованию). Это обеспечивает **прогрессивное раскрытие** — минимальный контекст на старте, детальные инструкции при необходимости.

Рекомендуемая структура держит файлы **менее 60 строк** для корневого CLAUDE.md, с детальными инструкциями в `.claude/commands/` и `.claude/agents/`. Критические секции включают:

```markdown
# Контекст проекта
[Однострочное описание того, что делает эта кодовая база]

# Команды
- npm run build: Сборка проекта
- npm run test: Запуск тестов (предпочитать одиночные тесты для скорости)
- npm run lint: Проверка стиля кода

# Стиль кода
- Использовать ES modules (import/export), не CommonJS
- TypeScript strict mode обязателен
- Предпочитать async/await вместо чистых промисов

# Верификация (ОБЯЗАТЕЛЬНО после изменений)
1. Запустить `npm run lint` - исправить все ошибки
2. Запустить `npm run typecheck` - исправить все ошибки
3. Запустить `npm run test` - убедиться что проходят
```

**Предупреждение об антипаттерне**: команды, поддерживающие CLAUDE.md файлы на 13KB+, наблюдают деградацию производительности. Автогенерация этих файлов также даёт плохие результаты — Anthropic рекомендует создавать вручную и итеративно улучшать эффективность, а не сбрасывать документацию.

Проекты сообщества используют **верификационные канарейки** («обращайся ко мне Капитан, чтобы подтвердить что ты прочитал это») для проверки того, что Claude обрабатывает файл. Клавиша `#` во время сессий добавляет инструкции, которые Claude автоматически включает в CLAUDE.md.

## Специализация субагентов следует паттерну оркестратор-воркер

Рекомендуемая Anthropic архитектура использует **ведущего агента**, координирующего специализированных воркеров, работающих параллельно. Каждый субагент обеспечивает разделение ответственности — отдельные инструменты, промпты и траектории исследования — снижая зависимость от пути.

Субагенты определяются в `.claude/agents/` с YAML frontmatter:

```markdown
---
name: code-reviewer
description: Использовать ПРОАКТИВНО после изменений кода для ревью качества
tools: Read, Grep, Glob, Bash
model: sonnet
---

Ты — старший код-ревьюер. Фокусируйся на:
1. Уязвимостях безопасности и валидации ввода
2. Архитектурном соответствии существующим паттернам
3. Последствиях для производительности (следи за O(n²) циклами)
4. Пробелах в тестовом покрытии

## Формат вывода
Предоставляй структурированную обратную связь с уровнями severity: CRITICAL, WARNING, SUGGESTION.
```

**Скоупинг инструментов критичен**: ревьюерам даётся только чтение (Read, Grep, Glob); имплементаторам — запись (Read, Write, Edit, Bash); исследователям — минимальные инструменты для быстрого, лёгкого исследования. Пропуск поля `tools` даёт все инструменты — всегда будьте намеренны.

Для автоматического делегирования включайте фразы действия типа **«Use PROACTIVELY»** или **«MUST BE USED»** в поля description. Без них агенты часто требуют явного вызова.

Рекомендуемый состав агентов для dev kit повторяет вашу текущую структуру:

| Агент | Назначение | Доступ к инструментам |
|-------|-----------|----------------------|
| lead-agent | Декомпозиция задач, оркестрация | Все инструменты |
| code-agent | Реализация | Read, Write, Edit, Bash |
| review-agent | Ревью качества и безопасности | Read, Grep, Glob |
| test-agent | Генерация и выполнение тестов | Все инструменты |
| explore-agent | Исследование кодовой базы | Read, Glob, Grep (только чтение) |
| doc-agent | Обновление документации | Read, Write |

## Управление контекстом предотвращает проблему «context rot»

Мультиагентные системы используют примерно **15× больше токенов** чем чат-взаимодействия. Даже с лимитом контекста в 200K токенов, эффективный recall деградирует задолго до лимита. Четыре стратегии решают это:

**Компактификация**: Команда `/compact` суммаризирует историю разговора при приближении к лимитам. Сохраняйте архитектурные решения и нерешённые вопросы; отбрасывайте избыточные выводы инструментов и старые сообщения. Настройте автоматическую компактификацию в Claude Agent SDK.

**Изоляция субагентов**: Каждый субагент работает со своим собственным свежим контекстным окном. Субагент может исследовать с 10,000+ токенами, но возвращает сжатое резюме в 1,000-2,000 токенов. Это достигает естественного сжатия.

**Структурированное ведение заметок**: Агенты пишут в персистентные файлы (NOTES.md, SESSION.md) вне контекстного окна, подтягивая заметки обратно при необходимости. Это позволяет отслеживать сложные задачи.

**Иерархическая загрузка контекста**: Используйте синтаксис `@path/to/file` для подключения файлов по требованию. CLAUDE.md файлы в поддиректориях загружаются только при доступе к этим директориям.

Ключевой принцип Anthropic: «Context engineering — это искусство курирования того, что попадает в ограниченное контекстное окно из постоянно развивающейся вселенной возможной информации.» Находите **наименьший возможный набор высокосигнальных токенов**.

## Длительные задачи требуют явного чекпоинтинга

Задачи, охватывающие несколько сессий, требуют осознанного управления состоянием. Основные паттерны:

**Файлы сессий** сохраняют рабочий контекст:

```markdown
# Сессия: 2025-01-16-auth-refactor

## Цели
- [ ] Реализовать OAuth провайдеров
- [x] Создать auth middleware
- [ ] Добавить управление сессиями

## Лог прогресса
### 14:30 - Завершена настройка OAuth
- Настроены провайдеры Google и GitHub
- Созданы обработчики callback

## Следующая сессия
1. Продолжить с управления сессиями
2. Запустить: npm run test:auth для проверки
```

**Story point sizing** направляет разбивку: 1-3 story points помещаются в один промпт; 5 points требуют одну сессию; 8+ points охватывают несколько сессий. Воркфлоу «Explore, Plan, Code, Commit» естественно разбивает большие задачи:

1. **Explore**: Читай файлы без кодинга — используй explore-agent для исследования
2. **Plan**: Используй «think hard» или «ultrathink» для расширенного рассуждения; сохрани план в файл
3. **Code**: Реализуй верифицируемыми инкрементами
4. **Commit**: Сохраняй прогресс часто как естественные чекпоинты

**Подготовка к восстановлению** включает создание маркеров состояния перед рискованными операциями. Git ветки предоставляют встроенный чекпоинтинг — `git commit -m "WIP: auth middleware functional"` создаёт точки восстановления.

Команды возобновления для Claude Code: `claude --continue` (последняя сессия), `claude --resume [session-id]` (конкретная сессия), или `claude --resume` (список доступных сессий).

## Применение TDD трансформирует качество AI-кода

TDD воркфлоу Anthropic адаптирует цикл Red-Green-Refactor:

1. Напиши тесты первыми на основе ожидаемых пар ввод/вывод
2. Попроси Claude запустить тесты и подтвердить что они падают (явно запрети реализацию)
3. Закоммить тесты
4. Попроси Claude написать код, проходящий тесты (запрети модификацию тестов)
5. Закоммить когда все тесты проходят

**TDD Guard** (github.com/nizos/tdd-guard) автоматизирует применение через хуки Claude Code:

```json
{
  "hooks": {
    "PreToolUse": [{
      "matcher": "Write|Edit|MultiEdit",
      "hooks": [{"type": "command", "command": "tdd-guard"}]
    }]
  }
}
```

Это блокирует реализацию без падающих тестов и предотвращает over-implementation сверх требований тестов.

**Мультиагентный TDD** борется с загрязнением контекста, когда логика тестов просачивается в реализацию. Используйте отдельных субагентов:
- TDD Test Writer: Создаёт падающие тесты без знания реализации
- TDD Implementer: Пишет минимальный код в свежем контексте
- TDD Refactorer: Оценивает улучшения с чистым контекстом

Это предотвращает «читерство» LLM путём подсознательного проектирования тестов под планируемую реализацию.

Конфигурация CLAUDE.md для TDD:

```markdown
## Подход к тестированию
- Генерировать типы/интерфейсы до реализации
- Создавать заглушки тестов, соответствующие требованиям
- Реализовывать прогрессивно до прохождения тестов
- Запускать тесты после КАЖДОГО изменения кода
- Коммитить только когда тесты проходят
```

## Атомарные коммиты обеспечивают безопасную итерацию

Подход «думай коммитами» размеряет промпты под размер коммита. Ключевые принципы:

- **Маленькие, фокусированные изменения**: Каждый промпт нацелен на один коммит
- **Читай каждую строку**: В отличие от «vibe coding», ревьюй весь AI-сгенерированный код перед коммитом
- **Атомарные коммиты для отката**: Более гранулярные коммиты упрощают навигацию по AI-assisted разработке

**Aider** (aider.chat) автоматически коммитит изменения с осмысленными сообщениями. **Atommit** анализирует staged изменения и предлагает разбить большие коммиты на фокусированные атомарные коммиты.

Паттерн двойного Claude ревью улучшает качество:
1. Первый Claude пишет код
2. Запусти `/clear` или запусти второй Claude
3. Второй Claude ревьюит работу первого Claude
4. Третий Claude читает и код и фидбек, затем редактирует

## Slash-команды оркестрируют сложные воркфлоу

Кастомные команды в `.claude/commands/` стандартизируют воркфлоу:

```markdown
# .claude/commands/implement-feature.md
Реализуй фичу: $ARGUMENTS

Следуй этому воркфлоу:
1. **Explore**: Прочитай релевантные файлы, пойми существующие паттерны
2. **Plan**: Тщательно продумай подход к реализации
3. **Test**: Напиши падающие тесты для фичи
4. **Code**: Реализуй минимальный код для прохождения тестов
5. **Verify**: Запусти lint, typecheck и все тесты
6. **Commit**: Создай описательный коммит в conventional формате
```

Популярные команды сообщества включают `/review` (комплексное код-ревью), `/catchup` (прочитай изменённые файлы в ветке), `/pr` (подготовь pull request), и `/security-review` (сканирование уязвимостей).

Предупреждение об антипаттерне от практиков: «Если у вас длинный список сложных кастомных slash-команд, вы создали антипаттерн. В момент когда вы заставляете инженера изучать магические команды, вы провалились.» Держите команды простыми и обнаруживаемыми.

## Quality gates интегрируются в CI/CD пайплайны

Многоуровневый контроль качества объединяет статический анализ, тестирование безопасности и AI-специфичные проверки:

```yaml
name: AI Code Quality
on: [pull_request]
jobs:
  ai-review:
    steps:
      - name: AI Code Review
        uses: tusgino/llm-code-reviewer@v1
      - name: Quality Gate
        run: npx sonarqube-scanner
```

**PostToolUse хуки** автоматизируют форматирование после каждой записи:

```json
{
  "hooks": {
    "PostToolUse": [{
      "matcher": "Write|Edit|MultiEdit",
      "hooks": [{
        "type": "command",
        "command": "eslint --fix $CLAUDE_FILE_PATH"
      }]
    }]
  }
}
```

Инструменты как **Qodo** пре-ревьюят каждый PR с AI агентами, а **SonarQube AI Code Assurance** предоставляет автоматические quality gates с поддержкой 30+ языков.

## Делегирование требует явных, детальных инструкций

Anthropic обнаружили, что короткие инструкции типа «исследуй дефицит полупроводников» приводили к размытым интерпретациям и дублированию работы между субагентами. Эффективное делегирование требует:

- **Ясная цель**: Единственная, конкретная цель
- **Формат вывода**: Ожидаемая структура результатов
- **Руководство по инструментам**: Какие инструменты использовать, какие источники приоритизировать
- **Границы задачи**: Явный scope для предотвращения пересечения

Масштабируйте усилия под сложность запроса:

| Сложность | Агенты | Вызовы инструментов |
|-----------|--------|---------------------|
| Простой поиск фактов | 1 агент | 3-10 вызовов |
| Прямые сравнения | 2-4 субагента | 10-15 каждый |
| Сложное исследование | 10+ субагентов | Разделённые ответственности |

Принцип «правильной высоты» балансирует специфичность и гибкость: слишком специфично создаёт хрупкую логику; слишком расплывчато не направляет. Оптимальные промпты достаточно специфичны чтобы направлять поведение, но достаточно гибки для сильных эвристик.

## Обработка ошибок и production deployment

Агенты stateful и ошибки накапливаются — нельзя просто перезапустить сначала. Стратегии смягчения:

- **Durable execution**: Стройте системы, которые возобновляются с места где произошли ошибки
- **Интеллект модели**: Дайте агентам знать когда инструменты падают; они адаптируются удивительно хорошо
- **Регулярные чекпоинты**: Обеспечивают восстановление без полного перезапуска
- **Rainbow deployments**: Постепенно перенаправляйте трафик; держите обе версии запущенными

Полная production трассировка позволяет диагностировать почему агенты упали. Фокусируйте observability на паттернах решений и структурах взаимодействия, не только на результатах.

## Рекомендуемая структура проекта для вашего Claude Code Kit

На основе этого исследования, оптимальная структура для мультиагентного проекта:

```
project/
├── CLAUDE.md                    # Краткий корневой конфиг (<60 строк)
├── CLAUDE.local.md             # Персональные настройки (gitignored)
├── .claude/
│   ├── commands/               # Slash-команды воркфлоу
│   │   ├── implement-feature.md
│   │   ├── fix-issue.md
│   │   └── review-changes.md
│   ├── agents/                 # Специализированные субагенты
│   │   ├── lead-agent.md
│   │   ├── code-agent.md
│   │   ├── review-agent.md
│   │   ├── test-agent.md
│   │   ├── explore-agent.md
│   │   └── doc-agent.md
│   └── settings.json           # Хуки, permissions
├── sessions/                   # Файлы состояния сессий
│   └── YYYY-MM-DD-name.md
├── docs/
│   ├── architecture.md         # Подключается через @
│   └── decisions/              # Architecture Decision Records
└── src/
    └── module/
        └── CLAUDE.md           # Паттерны специфичные для модуля
```

## Заключение

Исследование показывает, что эффективные мультиагентные системы Claude Code балансируют **явную конфигурацию** (CLAUDE.md, определения субагентов) с **гибкой оркестрацией** (делегирование ведущим агентом, сжатие контекста). Ключевые факторы успеха: держите корневую конфигурацию краткой, скоупите инструменты намеренно для каждого агента, делайте чекпоинты часто для длительных задач, применяйте TDD через хуки, и делегируйте с детальными инструкциями.

Наиболее влияющая практика от Anthropic: **«Использование токенов объясняет 80% вариации производительности.»** Обращение с контекстом как с конечным ресурсом — нахождение наименьшего набора высокосигнальных токенов — важнее чем изощрённый промптинг. Мультиагентные архитектуры успешны когда каждый субагент обеспечивает подлинное разделение ответственности, исследует независимо и возвращает сжатые инсайты вместо сырых данных.

Для вашего проекта Claude Code Kit приоритизируйте: (1) установление чётких специализаций агентов со скоупированными инструментами, (2) реализацию паттернов персистентности сессий для мультисессионных задач, (3) добавление TDD Guard или эквивалентных хуков для контроля качества, и (4) создание обнаруживаемых slash-команд для общих воркфлоу. Паттерн оркестратор-воркер с вашими шестью специализированными агентами хорошо позиционирует проект для сложных задач, превышающих одиночные контекстные окна.